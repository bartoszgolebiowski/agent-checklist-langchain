%% Mermaid state/flowchart for Checklist Agent workflow
flowchart LR
  subgraph INPUT[Input]
    WAITING_FOR_TASK_INPUT["WAITING_FOR_TASK_INPUT"]
  end

  WAITING_FOR_TASK_INPUT --> PARSING_TASK["PARSING_TASK"]
  PARSING_TASK --> SCOPING_AND_ASSUMPTIONS["SCOPING_AND_ASSUMPTIONS"]
  SCOPING_AND_ASSUMPTIONS --> DECIDING_RESEARCH["DECIDING_RESEARCH"]

  %% Research path and tool
  DECIDING_RESEARCH -->|decides research needed| WEB_RESEARCH["WEB_RESEARCH"]
  WEB_RESEARCH -->|search complete| SOURCE_SELECTION["SOURCE_SELECTION"]
  SOURCE_SELECTION --> EXTRACTING_SIGNALS["EXTRACTING_SIGNALS"]

  %% Main assembly path
  EXTRACTING_SIGNALS --> INTEGRATING_FINDINGS["INTEGRATING_FINDINGS"]
  INTEGRATING_FINDINGS --> OUTLINE_CHECKLIST_SKELETON["OUTLINE_CHECKLIST_SKELETON"]
  OUTLINE_CHECKLIST_SKELETON --> DRAFTING_CHECKLIST["DRAFTING_CHECKLIST"]
  DRAFTING_CHECKLIST --> DEEPENING_CHECKLIST["DEEPENING_CHECKLIST"]
  DEEPENING_CHECKLIST --> NORMALIZING_CHECKLIST["NORMALIZING_CHECKLIST"]
  NORMALIZING_CHECKLIST --> SELF_JUDGE["SELF_JUDGE"]

  %% Gap analysis branching based on self-judge
  SELF_JUDGE --> GAP_ANALYSIS["GAP_ANALYSIS"]
  GAP_ANALYSIS -->|needs_research| WEB_RESEARCH
  GAP_ANALYSIS -->|needs_depth| DEEPENING_CHECKLIST
  GAP_ANALYSIS -->|ready| FINALIZING_CHECKLIST["FINALIZING_CHECKLIST"]

  FINALIZING_CHECKLIST --> EMITTING_CHECKLIST["EMITTING_CHECKLIST"]
  EMITTING_CHECKLIST --> WAITING_FOR_TASK_INPUT["WAITING_FOR_TASK_INPUT (ready for new task)"]

  %% Error handling (suggested)
  subgraph ERRORS[Errors]
    TOOL_ERROR("TOOL_ERROR")
    SKILL_ERROR("SKILL_ERROR")
  end

  WEB_RESEARCH -->|tool failure| TOOL_ERROR
  anyError["any error"] --> SKILL_ERROR
  TOOL_ERROR -->|retry| WEB_RESEARCH
  SKILL_ERROR -->|retry| PARSING_TASK

  classDef error fill:#fdd,stroke:#900
  class TOOL_ERROR,SKILL_ERROR error
